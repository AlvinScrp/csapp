#######################################################
# CS:APP Bomb Lab
# 指导教师使用说明
#
# 版权所有 (c) 2003-2016, R. Bryant and D. O'Hallaron
#
#######################################################

此目录包含用于构建和运行 CS:APP Bomb Lab 的文件。Bomb Lab 教授学生机器级程序的原理，以及通用调试器和逆向工程的技能。

***********
1. 概述
***********

----
1.1. 二进制炸弹
----
“二进制炸弹”是一个 Linux 可执行的 C 程序，由六个“阶段”组成。每个阶段都期望学生在标准输入中输入一个特定的字符串。如果学生输入了预期的字符串，则该阶段被“解除”。否则，炸弹将通过打印“BOOM!!!”爆炸。学生的目标是尽可能多地解除各个阶段。

----
1.2. 解决二进制炸弹
----
为了解除炸弹，学生必须使用调试器（通常是 gdb 或 ddd）来反汇编二进制文件，并逐步执行每个阶段的机器代码。其目的是理解每条汇编语句的作用，然后利用这些知识推断出解除字符串。学生通过解除阶段获得积分，而每次爆炸都会扣分（由教师配置，通常为1/2分）。因此，他们很快就会学会在每个阶段和炸弹爆炸函数之前设置断点。这是一个很好的课程，迫使他们学会使用调试器。

----
1.3. 自动评分服务
----
我们创建了一个独立的用户级自动评分服务，处理 Bomb Lab 的所有方面：学生从服务器下载炸弹。当学生处理他们的炸弹时，每次爆炸和解除都会被流式传输回服务器，当前每个炸弹的结果显示在一个 Web “记分板”上。没有明确的提交，实验室是自评分的。

自动评分服务由四个在主 ./bomblab 目录中运行的用户级程序组成：

- 请求服务器 (bomblab-requestd.pl)。学生通过指向一个简单的 HTTP 服务器（称为“请求服务器”）来下载炸弹并显示记分板。请求服务器构建炸弹，将其存档在一个 tar 文件中，然后将生成的 tar 文件上传回浏览器，浏览器可以将其保存到磁盘并解压缩。请求服务器还为教师创建了炸弹及其解决方案的副本。

- 结果服务器 (bomblab-resultd.pl)。每次学生解除炸弹阶段或引发爆炸时，炸弹都会发送一条称为“自动结果字符串”的短 HTTP 消息到 HTTP “结果服务器”，结果服务器会将自动结果字符串附加到“记分板日志文件”中。

- 报告守护程序 (bomblab-reportd.pl)。报告守护程序定期扫描记分板日志文件。报告守护程序查找每个学生提交的每个阶段的最新解除字符串，并通过将这些字符串应用到学生炸弹的本地副本进行验证。然后，它更新 HTML 记分板，总结每个炸弹的当前爆炸和解除次数，按累计积分的总数排名。

- 主守护程序 (bomblab.pl)。主守护程序启动并监护请求服务器、结果服务器和报告守护程序，确保在任何时候只有这些进程（包括它自身）在运行。如果其中一个进程由于某种原因终止，主守护程序会检测到并自动重新启动它。主守护程序是你需要运行的唯一程序。

********
2. 文件
********
./bomblab 目录包含以下文件：

Makefile                - 用于启动/停止实验室和清理文件
bomblab.pl*             - 监护其他服务器和守护程序的主守护程序
Bomblab.pm              - Bomblab 配置文件    
bomblab-reportd.pl*     - 持续更新记分板的报告守护程序
bomblab-requestd.pl*    - 为学生提供炸弹的请求服务器
bomblab-resultd.pl*     - 从炸弹接收自动结果字符串的结果服务器
bomblab-scoreboard.html - 实时 Web 记分板
bomblab-update.pl*      - 更新记分板的报告守护程序的助手
bombs/                  - 存放发送给每个学生的炸弹
log-status.txt          - 各服务器和守护程序的状态日志
log.txt                 - 从炸弹接收到的自动结果的记分板日志
makebomb.pl*            - 构建炸弹的助手脚本
scores.txt              - 总结每个学生当前记分板得分
src/                    - 炸弹源文件
writeup/                - 样本 Latex Bomb Lab 说明文档

*******************
3. 炸弹术语
*******************

LabID: 每次实验的实例由教师选择的唯一名称标识，例如“f12”或“s13”。来自 LabID 与当前 LabID 不同的炸弹的爆炸和解除会被忽略。LabID 不能有空格。

BombID: 每次实验中的每个炸弹都有一个唯一的非负整数，称为“BombID”。

通知炸弹: 可以使用 NOTIFY 选项编译炸弹，使炸弹在学生爆炸或解除阶段时发送消息。这样的炸弹称为“通知炸弹”。

安静炸弹: 如果使用 NONOTIFY 选项编译炸弹，则炸弹在爆炸或解除时不发送任何消息。这样的炸弹称为“安静炸弹”。

我们还将区分定制炸弹和通用炸弹：

定制炸弹: “定制炸弹”的 BombID > 0，与特定学生相关联，可以是通知炸弹或安静炸弹。定制通知炸弹被限制在教师确定的一组特定的 Linux 主机上运行。而定制安静炸弹可以在任何 Linux 主机上运行。

通用炸弹: “通用炸弹”的 BombID = 0，不与任何特定学生相关联，是安静的，因此可以在任何主机上运行。

************************
4. 提供 Bomb Lab
************************
有两种基本的 Bomb Lab 版本：“在线”版本中，教师使用自动评分服务按需向每个学生发放定制通知炸弹，并自动跟踪他们在实时记分板上的进度。“离线”版本中，教师手动构建、发放和评分学生炸弹，而不使用自动评分服务。

虽然两种版本都给学生带来了丰富的体验，但我们推荐在线版本。这显然是最引人入胜和有趣的，并且对教师来说评分最容易。然而，它要求你保持自动评分服务不间断运行，因为发放、评分和报告会在实验室期间持续进行。我们已经使运行服务变得非常容易，但有些教师可能不喜欢这一要求，可能会选择离线版本。

以下是提供这两种版本实验室的说明。

---
4.1. 创建 Bomb Lab 目录
---
确定你将在其上创建 Bomb Lab 目录（./bomblab）并（如果你提供在线版本）运行自动评分服务的通用 Linux 机器 ($SERVER_NAME)。你只需要在这台机器上有一个用户帐户。不需要 root 权限。

每次 Bomb Lab 的实验都从 $SERVER_NAME 上的一个新的 ./bomblab 目录开始。例如：

    linux> tar xvf bomblab.tar
    linux> cd bomblab   
    linux> make cleanallfiles

---
4.2 配置 Bomb Lab
---
通过编辑以下文件来配置 Bomb Lab：

./Bomblab.pm - 这是主要配置文件。你只需修改或检查第1节中的几个变量。每个变量前都有描述性注释。如果你提供离线版本，可以忽略大多数这些设置。

如果你提供在线版本，还需要编辑以下文件：

./src/config.h - 此文件列出了允许通知炸弹运行的主机域名。确保正确更新此文件，否则你和你的学生将无法运行炸弹。

----
4.3. 更新实验说明文档
---

更新配置文件后，根据你的环境修改 ./writeup/bomblab.tex 中的 Latex 实验说明文档。然后在 ./writeup 目录中键入以下内容：

	unix> make clean
	unix> make 

这将创建 ps 和 pdf 版本的说明文档。

---
4.4. 运行在线 Bomb Lab
---

------
4.4.1. 简短版本
------
从 ./bomblab 目录开始：

(1) 通过键入以下命令从头开始重置 Bomb Lab
linux> make cleanallfiles

(2) 通过键入以下命令启动自动评分服务
linux> make start

(3) 通过键入以下命令停止自动评分服务
linux> make stop

你可以根据需要多次启动和停止自动评分服务而不丢失任何信息。如果有疑问，“make stop; make start” 将使所有内容处于稳定状态。

但是，重置实验会删除所有旧炸弹、状态日志和记分板日志。仅在调试期间或第一次为学生启动实验时执行此操作。

学生通过将他们的浏览器指向以下地址请求炸弹：
http://$SERVER_NAME:$REQUEST